{"version":3,"file":"electron-minidump.js","sources":["../../../src/main/integrations/electron-minidump.ts"],"sourcesContent":["import { applyScopeDataToEvent, convertIntegrationFnToClass, defineIntegration, getCurrentScope } from '@sentry/core';\nimport { NodeClient, NodeOptions } from '@sentry/node';\nimport { Event, ScopeData } from '@sentry/types';\nimport { logger, makeDsn, SentryError, uuid4 } from '@sentry/utils';\nimport { app, crashReporter } from 'electron';\n\nimport { mergeEvents, normalizeEvent } from '../../common';\nimport { getEventDefaults, getSdkInfo } from '../context';\nimport {\n  CRASH_REASONS,\n  onRendererProcessGone,\n  rendererRequiresCrashReporterStart,\n  usesCrashpad,\n} from '../electron-normalize';\nimport { checkPreviousSession, sessionCrashed, unreportedDuringLastSession } from '../sessions';\n\n/** Is object defined and has keys */\nfunction hasKeys(obj: object | undefined): boolean {\n  return obj !== undefined && Object.keys(obj).length > 0;\n}\n\n/** Gets a Scope object with user, tags and extra */\nfunction getScope(options: NodeOptions): Event {\n  const scope = getCurrentScope().getScopeData();\n\n  if (!scope) {\n    return {};\n  }\n\n  return {\n    release: options.release,\n    environment: options.environment,\n    /* eslint-disable @typescript-eslint/no-unsafe-member-access */\n    ...(hasKeys(scope.user) && { user: scope.user }),\n    ...(hasKeys(scope.tags) && { tags: scope.tags }),\n    ...(hasKeys(scope.extra) && { extra: scope.extra }),\n    /* eslint-enable @typescript-eslint/no-unsafe-member-access */\n  };\n}\n\n/** Chunks up event JSON into 1 or more parameters for use with the native Electron uploader\n *\n * Returns chunks with keys and values:\n * {\n *    sentry__1: '{ json...',\n *    sentry__2: 'more json...',\n *    sentry__x: 'end json }',\n * }\n */\nfunction getNativeUploaderExtraParams(event: Event): { [key: string]: string } {\n  const maxBytes = 20300;\n\n  /** Max chunk sizes are in bytes so we can't chunk by characters or UTF8 could bite us.\n   *\n   * We attempt to split by space (32) and double quote characters (34) as there are plenty in JSON\n   * and they are guaranteed to not be the first byte of a multi-byte UTF8 character.\n   */\n  let buf = Buffer.from(JSON.stringify(event));\n  const chunks = [];\n  while (buf.length) {\n    // Find last '\"'\n    let i = buf.lastIndexOf(34, maxBytes + 1);\n    // Or find last ' '\n    if (i < 0) i = buf.lastIndexOf(32, maxBytes + 1);\n    // Or find first '\"'\n    if (i < 0) i = buf.indexOf(34, maxBytes);\n    // Or find first ' '\n    if (i < 0) i = buf.indexOf(32, maxBytes);\n    // We couldn't find any space or quote chars so split at maxBytes and hope for the best 🤷‍♂️\n    if (i < 0) i = maxBytes;\n    chunks.push(buf.subarray(0, i + 1).toString());\n    buf = buf.subarray(i + 1);\n  }\n\n  return chunks.reduce((acc, cur, i) => {\n    acc[`sentry__${i + 1}`] = cur;\n    return acc;\n  }, {} as { [key: string]: string });\n}\n\n/**\n * Returns the minidump endpoint in Sentry\n * @param dsn Dsn\n */\nexport function minidumpUrlFromDsn(dsn: string): string | undefined {\n  const dsnComponents = makeDsn(dsn);\n  if (!dsnComponents) {\n    return undefined;\n  }\n  const { host, path, projectId, port, protocol, publicKey } = dsnComponents;\n  return `${protocol}://${host}${port !== '' ? `:${port}` : ''}${\n    path !== '' ? `/${path}` : ''\n  }/api/${projectId}/minidump/?sentry_key=${publicKey}`;\n}\n\nconst INTEGRATION_NAME = 'ElectronMinidump';\n\n/**\n * Sends minidumps via the Electron built-in uploader.\n */\nexport const electronMinidumpIntegration = defineIntegration(() => {\n  /** Counter used to ensure no race condition when updating extra params */\n  let updateEpoch = 0;\n  let customRelease: string | undefined;\n\n  async function getNativeUploaderEvent(scope: ScopeData): Promise<Event> {\n    const event = mergeEvents(await getEventDefaults(customRelease), {\n      sdk: getSdkInfo(),\n      event_id: uuid4(),\n      level: 'fatal',\n      platform: 'native',\n      tags: { 'event.environment': 'native', event_type: 'native' },\n    });\n\n    applyScopeDataToEvent(event, scope);\n\n    delete event.sdkProcessingMetadata;\n\n    // Normalise paths\n    return normalizeEvent(event, app.getAppPath());\n  }\n\n  function updateExtraParams(scope: ScopeData): void {\n    updateEpoch += 1;\n    const currentEpoch = updateEpoch;\n\n    getNativeUploaderEvent(scope)\n      .then((event) => {\n        if (currentEpoch !== updateEpoch) {\n          return;\n        }\n\n        // Update the extra parameters in the main process\n        const mainParams = getNativeUploaderExtraParams(event);\n        for (const key of Object.keys(mainParams)) {\n          crashReporter.addExtraParameter(key, mainParams[key]);\n        }\n      })\n      .catch((error) => logger.error(error));\n  }\n\n  function startCrashReporter(options: NodeOptions): void {\n    const submitURL = minidumpUrlFromDsn(options.dsn || '');\n    if (!submitURL) {\n      logger.log('Invalid DSN. Cannot start Electron crashReporter');\n      return;\n    }\n\n    // We don't add globalExtra when Breakpad is in use because it doesn't support JSON like strings:\n    // https://github.com/electron/electron/issues/29711\n    const globalExtra = usesCrashpad() ? { sentry___initialScope: JSON.stringify(getScope(options)) } : undefined;\n\n    logger.log('Starting Electron crashReporter');\n\n    crashReporter.start({\n      companyName: '',\n      ignoreSystemCrashHandler: true,\n      productName: app.name || app.getName(),\n      submitURL,\n      uploadToServer: true,\n      compress: true,\n      globalExtra,\n    });\n  }\n\n  function setupScopeListener(): void {\n    getCurrentScope().addScopeListener((updatedScope) => {\n      const scope = updatedScope.getScopeData();\n      scope.eventProcessors = [];\n      updateExtraParams(scope);\n    });\n  }\n\n  return {\n    name: INTEGRATION_NAME,\n    setupOnce() {\n      // noop\n    },\n    setup(client: NodeClient) {\n      // Mac AppStore builds cannot run the crash reporter due to the sandboxing\n      // requirements. In this case, we prevent enabling native crashes entirely.\n      // https://electronjs.org/docs/tutorial/mac-app-store-submission-guide#limitations-of-mas-build\n      if (process.mas) {\n        return;\n      }\n\n      if (rendererRequiresCrashReporterStart()) {\n        throw new SentryError(`The '${INTEGRATION_NAME}' integration is only supported with Electron >= v9`);\n      }\n\n      const clientOptions = client.getOptions();\n\n      if (!clientOptions?.dsn) {\n        throw new SentryError('Attempted to enable Electron native crash reporter but no DSN was supplied');\n      }\n\n      customRelease = clientOptions.release;\n\n      startCrashReporter(clientOptions);\n\n      // If a renderer process crashes, mark any existing session as crashed\n      onRendererProcessGone(CRASH_REASONS, (_, __) => {\n        sessionCrashed();\n      });\n\n      // If we're using the Crashpad minidump uploader, we set extra parameters whenever the scope updates\n      if (usesCrashpad()) {\n        setupScopeListener();\n      }\n\n      // Check if last crash report was likely to have been unreported in the last session\n      unreportedDuringLastSession(crashReporter.getLastCrashReport()?.date).then((crashed) => {\n        // Check if a previous session was not closed\n        return checkPreviousSession(crashed);\n      }, logger.error);\n    },\n  };\n});\n\n/**\n * Sends minidumps via the Electron built-in uploader.\n *\n * @deprecated Use `electronMinidumpIntegration()` instead\n */\n// eslint-disable-next-line deprecation/deprecation\nexport const ElectronMinidump = convertIntegrationFnToClass(INTEGRATION_NAME, electronMinidumpIntegration);\n"],"names":[],"mappings":";;;;;;;;;;AAgBA;AACA,SAAS,OAAO,CAAC,GAAuB,EAAA;AACtC,IAAA,OAAO,GAAG,KAAK,SAAS,IAAI,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,MAAM,GAAG,CAAC,CAAC;AAC1D,CAAC;AAED;AACA,SAAS,QAAQ,CAAC,OAAoB,EAAA;AACpC,IAAA,MAAM,KAAK,GAAG,eAAe,EAAE,CAAC,YAAY,EAAE,CAAC;IAE/C,IAAI,CAAC,KAAK,EAAE;AACV,QAAA,OAAO,EAAE,CAAC;AACX,KAAA;AAED,IAAA,OAAA,MAAA,CAAA,MAAA,CAAA,MAAA,CAAA,MAAA,CAAA,MAAA,CAAA,MAAA,CAAA,EACE,OAAO,EAAE,OAAO,CAAC,OAAO,EACxB,WAAW,EAAE,OAAO,CAAC,WAAW,EAAA,GAE5B,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,EAAE,KAAK,CAAC,IAAI,EAAE,KAC3C,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,EAAE,KAAK,CAAC,IAAI,EAAE,EAC5C,GAAC,OAAO,CAAC,KAAK,CAAC,KAAK,CAAC,IAAI,EAAE,KAAK,EAAE,KAAK,CAAC,KAAK,EAAE,EAElD,CAAA;AACJ,CAAC;AAED;;;;;;;;AAQG;AACH,SAAS,4BAA4B,CAAC,KAAY,EAAA;IAChD,MAAM,QAAQ,GAAG,KAAK,CAAC;AAEvB;;;;AAIG;AACH,IAAA,IAAI,GAAG,GAAG,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC,CAAC;IAC7C,MAAM,MAAM,GAAG,EAAE,CAAC;IAClB,OAAO,GAAG,CAAC,MAAM,EAAE;;AAEjB,QAAA,IAAI,CAAC,GAAG,GAAG,CAAC,WAAW,CAAC,EAAE,EAAE,QAAQ,GAAG,CAAC,CAAC,CAAC;;QAE1C,IAAI,CAAC,GAAG,CAAC;YAAE,CAAC,GAAG,GAAG,CAAC,WAAW,CAAC,EAAE,EAAE,QAAQ,GAAG,CAAC,CAAC,CAAC;;QAEjD,IAAI,CAAC,GAAG,CAAC;YAAE,CAAC,GAAG,GAAG,CAAC,OAAO,CAAC,EAAE,EAAE,QAAQ,CAAC,CAAC;;QAEzC,IAAI,CAAC,GAAG,CAAC;YAAE,CAAC,GAAG,GAAG,CAAC,OAAO,CAAC,EAAE,EAAE,QAAQ,CAAC,CAAC;;QAEzC,IAAI,CAAC,GAAG,CAAC;YAAE,CAAC,GAAG,QAAQ,CAAC;AACxB,QAAA,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC,QAAQ,EAAE,CAAC,CAAC;QAC/C,GAAG,GAAG,GAAG,CAAC,QAAQ,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC;AAC3B,KAAA;IAED,OAAO,MAAM,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,GAAG,EAAE,CAAC,KAAI;QACnC,GAAG,CAAC,WAAW,CAAC,GAAG,CAAC,CAAE,CAAA,CAAC,GAAG,GAAG,CAAC;AAC9B,QAAA,OAAO,GAAG,CAAC;KACZ,EAAE,EAA+B,CAAC,CAAC;AACtC,CAAC;AAED;;;AAGG;AACG,SAAU,kBAAkB,CAAC,GAAW,EAAA;AAC5C,IAAA,MAAM,aAAa,GAAG,OAAO,CAAC,GAAG,CAAC,CAAC;IACnC,IAAI,CAAC,aAAa,EAAE;AAClB,QAAA,OAAO,SAAS,CAAC;AAClB,KAAA;AACD,IAAA,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,SAAS,EAAE,IAAI,EAAE,QAAQ,EAAE,SAAS,EAAE,GAAG,aAAa,CAAC;AAC3E,IAAA,OAAO,GAAG,QAAQ,CAAA,GAAA,EAAM,IAAI,CAAA,EAAG,IAAI,KAAK,EAAE,GAAG,CAAI,CAAA,EAAA,IAAI,CAAE,CAAA,GAAG,EAAE,CAC1D,EAAA,IAAI,KAAK,EAAE,GAAG,IAAI,IAAI,CAAA,CAAE,GAAG,EAC7B,CAAA,KAAA,EAAQ,SAAS,CAAyB,sBAAA,EAAA,SAAS,EAAE,CAAC;AACxD,CAAC;AAED,MAAM,gBAAgB,GAAG,kBAAkB,CAAC;AAE5C;;AAEG;AACU,MAAA,2BAA2B,GAAG,iBAAiB,CAAC,MAAK;;IAEhE,IAAI,WAAW,GAAG,CAAC,CAAC;AACpB,IAAA,IAAI,aAAiC,CAAC;IAEtC,SAAe,sBAAsB,CAAC,KAAgB,EAAA;;YACpD,MAAM,KAAK,GAAG,WAAW,CAAC,MAAM,gBAAgB,CAAC,aAAa,CAAC,EAAE;gBAC/D,GAAG,EAAE,UAAU,EAAE;gBACjB,QAAQ,EAAE,KAAK,EAAE;AACjB,gBAAA,KAAK,EAAE,OAAO;AACd,gBAAA,QAAQ,EAAE,QAAQ;gBAClB,IAAI,EAAE,EAAE,mBAAmB,EAAE,QAAQ,EAAE,UAAU,EAAE,QAAQ,EAAE;AAC9D,aAAA,CAAC,CAAC;AAEH,YAAA,qBAAqB,CAAC,KAAK,EAAE,KAAK,CAAC,CAAC;YAEpC,OAAO,KAAK,CAAC,qBAAqB,CAAC;;YAGnC,OAAO,cAAc,CAAC,KAAK,EAAE,GAAG,CAAC,UAAU,EAAE,CAAC,CAAC;SAChD,CAAA,CAAA;AAAA,KAAA;IAED,SAAS,iBAAiB,CAAC,KAAgB,EAAA;QACzC,WAAW,IAAI,CAAC,CAAC;QACjB,MAAM,YAAY,GAAG,WAAW,CAAC;QAEjC,sBAAsB,CAAC,KAAK,CAAC;AAC1B,aAAA,IAAI,CAAC,CAAC,KAAK,KAAI;YACd,IAAI,YAAY,KAAK,WAAW,EAAE;gBAChC,OAAO;AACR,aAAA;;AAGD,YAAA,MAAM,UAAU,GAAG,4BAA4B,CAAC,KAAK,CAAC,CAAC;YACvD,KAAK,MAAM,GAAG,IAAI,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,EAAE;gBACzC,aAAa,CAAC,iBAAiB,CAAC,GAAG,EAAE,UAAU,CAAC,GAAG,CAAC,CAAC,CAAC;AACvD,aAAA;AACH,SAAC,CAAC;AACD,aAAA,KAAK,CAAC,CAAC,KAAK,KAAK,MAAM,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC;KAC1C;IAED,SAAS,kBAAkB,CAAC,OAAoB,EAAA;QAC9C,MAAM,SAAS,GAAG,kBAAkB,CAAC,OAAO,CAAC,GAAG,IAAI,EAAE,CAAC,CAAC;QACxD,IAAI,CAAC,SAAS,EAAE;AACd,YAAA,MAAM,CAAC,GAAG,CAAC,kDAAkD,CAAC,CAAC;YAC/D,OAAO;AACR,SAAA;;;QAID,MAAM,WAAW,GAAG,YAAY,EAAE,GAAG,EAAE,qBAAqB,EAAE,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC,EAAE,GAAG,SAAS,CAAC;AAE9G,QAAA,MAAM,CAAC,GAAG,CAAC,iCAAiC,CAAC,CAAC;QAE9C,aAAa,CAAC,KAAK,CAAC;AAClB,YAAA,WAAW,EAAE,EAAE;AACf,YAAA,wBAAwB,EAAE,IAAI;YAC9B,WAAW,EAAE,GAAG,CAAC,IAAI,IAAI,GAAG,CAAC,OAAO,EAAE;YACtC,SAAS;AACT,YAAA,cAAc,EAAE,IAAI;AACpB,YAAA,QAAQ,EAAE,IAAI;YACd,WAAW;AACZ,SAAA,CAAC,CAAC;KACJ;AAED,IAAA,SAAS,kBAAkB,GAAA;AACzB,QAAA,eAAe,EAAE,CAAC,gBAAgB,CAAC,CAAC,YAAY,KAAI;AAClD,YAAA,MAAM,KAAK,GAAG,YAAY,CAAC,YAAY,EAAE,CAAC;AAC1C,YAAA,KAAK,CAAC,eAAe,GAAG,EAAE,CAAC;YAC3B,iBAAiB,CAAC,KAAK,CAAC,CAAC;AAC3B,SAAC,CAAC,CAAC;KACJ;IAED,OAAO;AACL,QAAA,IAAI,EAAE,gBAAgB;QACtB,SAAS,GAAA;;SAER;AACD,QAAA,KAAK,CAAC,MAAkB,EAAA;;;;;YAItB,IAAI,OAAO,CAAC,GAAG,EAAE;gBACf,OAAO;AACR,aAAA;YAED,IAAI,kCAAkC,EAAE,EAAE;AACxC,gBAAA,MAAM,IAAI,WAAW,CAAC,QAAQ,gBAAgB,CAAA,mDAAA,CAAqD,CAAC,CAAC;AACtG,aAAA;AAED,YAAA,MAAM,aAAa,GAAG,MAAM,CAAC,UAAU,EAAE,CAAC;YAE1C,IAAI,EAAC,aAAa,KAAb,IAAA,IAAA,aAAa,uBAAb,aAAa,CAAE,GAAG,CAAA,EAAE;AACvB,gBAAA,MAAM,IAAI,WAAW,CAAC,4EAA4E,CAAC,CAAC;AACrG,aAAA;AAED,YAAA,aAAa,GAAG,aAAa,CAAC,OAAO,CAAC;YAEtC,kBAAkB,CAAC,aAAa,CAAC,CAAC;;YAGlC,qBAAqB,CAAC,aAAa,EAAE,CAAC,CAAC,EAAE,EAAE,KAAI;AAC7C,gBAAA,cAAc,EAAE,CAAC;AACnB,aAAC,CAAC,CAAC;;YAGH,IAAI,YAAY,EAAE,EAAE;AAClB,gBAAA,kBAAkB,EAAE,CAAC;AACtB,aAAA;;AAGD,YAAA,2BAA2B,CAAC,CAAA,EAAA,GAAA,aAAa,CAAC,kBAAkB,EAAE,MAAA,IAAA,IAAA,EAAA,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAAA,EAAA,CAAE,IAAI,CAAC,CAAC,IAAI,CAAC,CAAC,OAAO,KAAI;;AAErF,gBAAA,OAAO,oBAAoB,CAAC,OAAO,CAAC,CAAC;AACvC,aAAC,EAAE,MAAM,CAAC,KAAK,CAAC,CAAC;SAClB;KACF,CAAC;AACJ,CAAC,EAAE;AAEH;;;;AAIG;AACH;AACa,MAAA,gBAAgB,GAAG,2BAA2B,CAAC,gBAAgB,EAAE,2BAA2B;;;;"}