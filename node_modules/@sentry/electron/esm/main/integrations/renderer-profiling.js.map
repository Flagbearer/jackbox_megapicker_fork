{"version":3,"file":"renderer-profiling.js","sources":["../../../src/main/integrations/renderer-profiling.ts"],"sourcesContent":["import { convertIntegrationFnToClass, defineIntegration } from '@sentry/core';\nimport { Event, Profile } from '@sentry/types';\nimport { forEachEnvelopeItem, LRUMap } from '@sentry/utils';\nimport { app } from 'electron';\n\nimport { normaliseProfile } from '../../common';\nimport { getDefaultEnvironment, getDefaultReleaseName } from '../context';\nimport { ELECTRON_MAJOR_VERSION } from '../electron-normalize';\nimport { ElectronMainOptionsInternal } from '../sdk';\n\nconst DOCUMENT_POLICY_HEADER = 'Document-Policy';\nconst JS_PROFILING_HEADER = 'js-profiling';\n\n// A cache of renderer profiles which need attaching to events\nlet RENDERER_PROFILES: LRUMap<string, Profile> | undefined;\n\n/**\n * Caches a profile to later be re-attached to an event\n */\nexport function rendererProfileFromIpc(event: Event, profile: Profile): void {\n  if (!RENDERER_PROFILES) {\n    return;\n  }\n\n  const profile_id = profile.event_id;\n  RENDERER_PROFILES.set(profile_id, profile);\n\n  if (event) {\n    event.contexts = {\n      ...event.contexts,\n      // Re-add the profile context which we can later use to find the correct profile\n      profile: {\n        profile_id,\n      },\n    };\n  }\n}\n\nfunction addJsProfilingHeader(\n  responseHeaders: Record<string, string | string[]> = {},\n): Electron.HeadersReceivedResponse {\n  if (responseHeaders[DOCUMENT_POLICY_HEADER]) {\n    const docPolicy = responseHeaders[DOCUMENT_POLICY_HEADER];\n\n    if (Array.isArray(docPolicy)) {\n      docPolicy.push(JS_PROFILING_HEADER);\n    } else {\n      responseHeaders[DOCUMENT_POLICY_HEADER] = [docPolicy, JS_PROFILING_HEADER];\n    }\n  } else {\n    responseHeaders[DOCUMENT_POLICY_HEADER] = JS_PROFILING_HEADER;\n  }\n\n  return { responseHeaders };\n}\n\nconst INTEGRATION_NAME = 'RendererProfiling';\n\n/**\n * Injects 'js-profiling' document policy headers and ensures that profiles get forwarded with transactions\n */\nexport const rendererProfilingIntegration = defineIntegration(() => {\n  return {\n    name: INTEGRATION_NAME,\n    setupOnce() {\n      // noop\n    },\n    setup(client) {\n      const options = client.getOptions() as ElectronMainOptionsInternal;\n      if (!options.enableRendererProfiling) {\n        return;\n      }\n\n      if (ELECTRON_MAJOR_VERSION < 15) {\n        throw new Error('Renderer profiling requires Electron 15+ (Chromium 94+)');\n      }\n\n      RENDERER_PROFILES = new LRUMap(10);\n\n      app.on('ready', () => {\n        // Ensure the correct headers are set to enable the browser profiler\n        for (const sesh of options.getSessions()) {\n          sesh.webRequest.onHeadersReceived((details, callback) => {\n            callback(addJsProfilingHeader(details.responseHeaders));\n          });\n        }\n      });\n\n      // Copy the profiles back into the event envelopes\n      client.on?.('beforeEnvelope', (envelope) => {\n        let profile_id: string | undefined;\n\n        forEachEnvelopeItem(envelope, (item, type) => {\n          if (type !== 'transaction') {\n            return;\n          }\n\n          for (let j = 1; j < item.length; j++) {\n            const event = item[j] as Event;\n\n            if (event?.contexts?.profile?.profile_id) {\n              profile_id = event.contexts.profile.profile_id as string;\n              // This can be removed as it's no longer needed\n              delete event.contexts.profile;\n            }\n          }\n        });\n\n        if (!profile_id) {\n          return;\n        }\n\n        const profile = RENDERER_PROFILES?.remove(profile_id);\n\n        if (!profile) {\n          return;\n        }\n\n        normaliseProfile(profile, app.getAppPath());\n        profile.release = options.release || getDefaultReleaseName();\n        profile.environment = options.environment || getDefaultEnvironment();\n\n        // @ts-expect-error untyped envelope\n        envelope[1].push([{ type: 'profile' }, profile]);\n      });\n    },\n  };\n});\n\n/**\n * Injects 'js-profiling' document policy headers and ensures that profiles get forwarded with transactions\n *\n * @deprecated Use `rendererProfilingIntegration()` instead\n */\n// eslint-disable-next-line deprecation/deprecation\nexport const RendererProfiling = convertIntegrationFnToClass(INTEGRATION_NAME, rendererProfilingIntegration);\n"],"names":[],"mappings":"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"}