{"version":3,"file":"anr.js","sources":["../../src/main/anr.ts"],"sourcesContent":["import { captureEvent, createGetModuleFromFilename, getClient, NodeClient, StackFrame } from '@sentry/node';\nimport { Event } from '@sentry/types';\nimport { callFrameToStackFrame, logger, stripSentryFramesAndReverse, watchdogTimer } from '@sentry/utils';\nimport { app, WebContents } from 'electron';\n\nimport { RendererStatus } from '../common';\nimport { Anr } from './integrations/anr';\nimport { ElectronMainOptions } from './sdk';\nimport { sessionAnr } from './sessions';\n\nfunction getRendererName(contents: WebContents): string | undefined {\n  const options = getClient()?.getOptions() as ElectronMainOptions | undefined;\n  return options?.getRendererName?.(contents);\n}\n\nfunction sendRendererAnrEvent(contents: WebContents, blockedMs: number, frames?: StackFrame[]): void {\n  sessionAnr();\n\n  const rendererName = getRendererName(contents) || 'renderer';\n\n  const event: Event = {\n    level: 'error',\n    exception: {\n      values: [\n        {\n          type: 'ApplicationNotResponding',\n          value: `Application Not Responding for at least ${blockedMs} ms`,\n          stacktrace: { frames },\n          mechanism: {\n            // This ensures the UI doesn't say 'Crashed in' for the stack trace\n            type: 'ANR',\n          },\n        },\n      ],\n    },\n    tags: {\n      'event.process': rendererName,\n    },\n  };\n\n  captureEvent(event);\n}\n\ninterface ScriptParsedEventDataType {\n  scriptId: string;\n  url: string;\n}\n\ninterface Location {\n  scriptId: string;\n  lineNumber: number;\n  columnNumber?: number;\n}\n\ninterface CallFrame {\n  functionName: string;\n  location: Location;\n  url: string;\n}\n\ninterface PausedEventDataType {\n  callFrames: CallFrame[];\n  reason: string;\n}\n\nfunction rendererDebugger(contents: WebContents, pausedStack: (frames: StackFrame[]) => void): () => void {\n  contents.debugger.attach('1.3');\n\n  // Collect scriptId -> url map so we can look up the filenames later\n  const scripts = new Map<string, string>();\n  const getModuleFromFilename = createGetModuleFromFilename(app.getAppPath());\n\n  contents.debugger.on('message', (_, method, params) => {\n    if (method === 'Debugger.scriptParsed') {\n      const param = params as ScriptParsedEventDataType;\n      scripts.set(param.scriptId, param.url);\n    } else if (method === 'Debugger.paused') {\n      const param = params as PausedEventDataType;\n\n      if (param.reason !== 'other') {\n        return;\n      }\n\n      // copy the frames\n      const callFrames = [...param.callFrames];\n\n      contents.debugger.sendCommand('Debugger.resume').then(null, () => {\n        // ignore\n      });\n\n      const stackFrames = stripSentryFramesAndReverse(\n        callFrames.map((frame) =>\n          callFrameToStackFrame(frame, scripts.get(frame.location.scriptId), getModuleFromFilename),\n        ),\n      );\n\n      pausedStack(stackFrames);\n    }\n  });\n\n  // In node, we enable just before pausing but for Chrome, the debugger must be enabled before he ANR event occurs\n  contents.debugger.sendCommand('Debugger.enable').catch(() => {\n    // ignore\n  });\n\n  return () => {\n    return contents.debugger.sendCommand('Debugger.pause');\n  };\n}\n\nlet rendererWatchdogTimers: Map<WebContents, ReturnType<typeof watchdogTimer>> | undefined;\n\nfunction createHrTimer(): { getTimeMs: () => number; reset: () => void } {\n  let lastPoll = process.hrtime();\n\n  return {\n    getTimeMs: (): number => {\n      const [seconds, nanoSeconds] = process.hrtime(lastPoll);\n      return Math.floor(seconds * 1e3 + nanoSeconds / 1e6);\n    },\n    reset: (): void => {\n      lastPoll = process.hrtime();\n    },\n  };\n}\n\n/** Creates a renderer ANR status hook */\nexport function createRendererAnrStatusHandler(): (status: RendererStatus, contents: WebContents) => void {\n  function log(message: string, ...args: unknown[]): void {\n    logger.log(`[Renderer ANR] ${message}`, ...args);\n  }\n\n  return (message: RendererStatus, contents: WebContents): void => {\n    rendererWatchdogTimers = rendererWatchdogTimers || new Map();\n\n    let watchdog = rendererWatchdogTimers.get(contents);\n\n    if (watchdog === undefined) {\n      log('Renderer sent first status message', message.config);\n      let pauseAndCapture: (() => void) | undefined;\n\n      if (message.config.captureStackTrace) {\n        log('Connecting to debugger');\n        pauseAndCapture = rendererDebugger(contents, (frames) => {\n          log('Event captured with stack frames');\n          sendRendererAnrEvent(contents, message.config.anrThreshold, frames);\n        });\n      }\n\n      watchdog = watchdogTimer(createHrTimer, 100, message.config.anrThreshold, async () => {\n        log('Watchdog timeout');\n        if (pauseAndCapture) {\n          log('Pausing debugger to capture stack trace');\n          pauseAndCapture();\n        } else {\n          log('Capturing event');\n          sendRendererAnrEvent(contents, message.config.anrThreshold);\n        }\n      });\n\n      contents.once('destroyed', () => {\n        rendererWatchdogTimers?.delete(contents);\n      });\n\n      rendererWatchdogTimers.set(contents, watchdog);\n    }\n\n    watchdog.poll();\n\n    if (message.status !== 'alive') {\n      log('Renderer visibility changed', message.status);\n      watchdog.enabled(message.status === 'visible');\n    }\n  };\n}\n\ninterface LegacyOptions {\n  entryScript: string;\n  pollInterval: number;\n  anrThreshold: number;\n  captureStackTrace: boolean;\n  debug: boolean;\n}\n\n/**\n * @deprecated Use `Anr` integration instead.\n *\n * ```js\n * import { init, anrIntegration } from '@sentry/electron';\n *\n * init({\n *   dsn: \"__DSN__\",\n *   integrations: [anrIntegration({ captureStackTrace: true })],\n * });\n * ```\n */\nexport function enableMainProcessAnrDetection(options: Partial<LegacyOptions> = {}): Promise<void> {\n  // eslint-disable-next-line deprecation/deprecation\n  const integration = new Anr(options);\n  const client = getClient() as NodeClient;\n  integration.setup?.(client);\n  return Promise.resolve();\n}\n"],"names":[],"mappings":"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"}