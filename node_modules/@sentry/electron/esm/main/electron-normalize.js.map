{"version":3,"file":"electron-normalize.js","sources":["../../src/main/electron-normalize.ts"],"sourcesContent":["import { parseSemver } from '@sentry/utils';\nimport { app, BrowserWindow, crashReporter, NativeImage, WebContents } from 'electron';\nimport { basename } from 'path';\n\nimport { RENDERER_ID_HEADER } from '../common/ipc';\nimport { Optional } from '../common/types';\n\nconst parsed = parseSemver(process.versions.electron);\nconst version = { major: parsed.major || 0, minor: parsed.minor || 0, patch: parsed.patch || 0 };\n\nexport const ELECTRON_MAJOR_VERSION = version.major;\n\n/** Returns if the app is packaged. Copied from Electron to support < v3 */\nexport const isPackaged = (() => {\n  const execFile = basename(process.execPath).toLowerCase();\n  if (process.platform === 'win32') {\n    return execFile !== 'electron.exe';\n  }\n  return execFile !== 'electron';\n})();\n\n/** A promise that is resolved when the app is ready */\nexport const whenAppReady: Promise<void> = (() => {\n  if (app) {\n    return app.isReady()\n      ? Promise.resolve()\n      : new Promise<void>((resolve) => {\n          app.once('ready', () => {\n            resolve();\n          });\n        });\n  }\n\n  return Promise.resolve();\n})();\n\n/**\n * Electron >= 5 support full protocol API\n */\nexport function supportsFullProtocol(): boolean {\n  return version.major >= 5;\n}\n\nexport const EXIT_REASONS = [\n  'clean-exit',\n  'abnormal-exit',\n  'killed',\n  'crashed',\n  'oom',\n  'launch-failed',\n  'integrity-failure',\n] as const;\nexport type ExitReason = (typeof EXIT_REASONS)[number];\nexport const CRASH_REASONS: Readonly<ExitReason[]> = ['crashed', 'oom'] as const;\n\n/** Same as the Electron interface but with optional exitCode */\ntype RenderProcessGoneDetails = Optional<Electron.RenderProcessGoneDetails, 'exitCode'>;\n\n/**\n * Implements 'render-process-gone' event across Electron versions\n */\nexport function onRendererProcessGone(\n  reasons: Readonly<ExitReason[]>,\n  callback: (contents: WebContents, details: RenderProcessGoneDetails) => void,\n): void {\n  const supportsRenderProcessGone =\n    version.major >= 10 || (version.major === 9 && version.minor >= 1) || (version.major === 8 && version.minor >= 4);\n  if (supportsRenderProcessGone) {\n    app.on('render-process-gone', (_, contents, details) => {\n      if (reasons.includes(details.reason)) {\n        callback(contents, details);\n      }\n    });\n  } else {\n    onWebContentsCreated((contents) => {\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n      (contents as any).on('crashed', (__: Electron.Event, killed: boolean) => {\n        // When using Breakpad, crashes are incorrectly reported as killed\n        const reason: ExitReason = usesCrashpad() && killed ? 'killed' : 'crashed';\n\n        if (reasons.includes(reason)) {\n          callback(contents, { reason });\n        }\n      });\n    });\n  }\n}\n\ntype Details = Optional<Electron.Details, 'exitCode'>;\n\n/**\n * Calls callback on child process crash if Electron version support 'child-process-gone' event\n */\nexport function onChildProcessGone(reasons: Readonly<ExitReason[]>, callback: (details: Details) => void): void {\n  if (version.major >= 11) {\n    app.on('child-process-gone', (_, details) => {\n      if (reasons.includes(details.reason)) {\n        callback(details);\n      }\n    });\n  } else {\n    // eslint-disable-next-line deprecation/deprecation\n    app.on('gpu-process-crashed', (_, killed) => {\n      const reason: ExitReason = killed ? 'killed' : 'crashed';\n\n      if (reasons.includes(reason)) {\n        callback({ type: 'GPU', reason });\n      }\n    });\n  }\n}\n\n/** Calls callback when BrowserWindow are created */\nexport function onBrowserWindowCreated(callback: (window: BrowserWindow) => void): void {\n  app.on('browser-window-created', (_, window) => {\n    // SetImmediate is required for window.id to be correct in older versions of Electron\n    // https://github.com/electron/electron/issues/12036\n    if (version.major >= 3) {\n      callback(window);\n    } else {\n      setImmediate(() => {\n        if (window.isDestroyed()) {\n          return;\n        }\n\n        callback(window);\n      });\n    }\n  });\n}\n\n/** Calls callback when WebContents are created */\nexport function onWebContentsCreated(callback: (window: WebContents) => void): void {\n  app.on('web-contents-created', (_, contents) => {\n    // SetImmediate is required for contents.id to be correct in older versions of Electron\n    // https://github.com/electron/electron/issues/12036\n    if (version.major >= 3) {\n      callback(contents);\n    } else {\n      setImmediate(() => {\n        if (contents.isDestroyed()) {\n          return;\n        }\n\n        callback(contents);\n      });\n    }\n  });\n}\n\n/**\n * Electron < 9 requires `crashReporter.start()` in the renderer\n */\nexport function rendererRequiresCrashReporterStart(): boolean {\n  if (process.platform === 'darwin') {\n    return false;\n  }\n\n  return version.major < 9;\n}\n\n/**\n * Uses Crashpad on Linux\n * https://github.com/electron/electron/issues/27859\n */\nfunction crashpadLinux(): boolean {\n  if (version.major >= 16) {\n    return true;\n  }\n\n  if (version.major < 15) {\n    return false;\n  }\n\n  // Crashpad Linux for v15 is behind a switch\n  return app.commandLine.hasSwitch('enable-crashpad');\n}\n\n/** Is using Crashpad */\nexport function usesCrashpad(): boolean {\n  return (\n    process.platform === 'darwin' ||\n    (process.platform === 'win32' && version.major >= 6) ||\n    (process.platform === 'linux' && crashpadLinux())\n  );\n}\n\n/**\n * Electron >= 9 uses `app.getPath('crashDumps')` rather than\n * `crashReporter.getCrashesDirectory()`\n */\nexport function getCrashesDirectory(): string {\n  return version.major >= 9\n    ? app.getPath('crashDumps')\n    : // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n      (crashReporter as any).getCrashesDirectory();\n}\n\ninterface OlderBrowserWindow extends Omit<BrowserWindow, 'capturePage'> {\n  capturePage(callback?: (i: NativeImage) => void): void;\n}\n\n/** Captures a NativeImage from a BrowserWindow */\nexport function capturePage(window: BrowserWindow): Promise<NativeImage> {\n  // Pre-Electron 5, BrowserWindow.capturePage() uses callbacks\n  if (version.major < 5) {\n    return new Promise<NativeImage>((resolve) => {\n      (window as OlderBrowserWindow).capturePage(resolve);\n    });\n  }\n\n  return window.capturePage();\n}\n\n/**\n * Electron >= 25 support `protocol.handle`\n */\nfunction supportsProtocolHandle(): boolean {\n  return version.major >= 25;\n}\n\ninterface InternalRequest {\n  windowId?: string;\n  url: string;\n  body?: Buffer;\n}\n\n/**\n * Registers a custom protocol to receive events from the renderer\n *\n * Uses `protocol.handle` if available, otherwise falls back to `protocol.registerStringProtocol`\n */\nexport function registerProtocol(\n  protocol: Electron.Protocol,\n  scheme: string,\n  callback: (request: InternalRequest) => void,\n): void {\n  if (supportsProtocolHandle()) {\n    protocol.handle(scheme, async (request) => {\n      callback({\n        windowId: request.headers.get(RENDERER_ID_HEADER) || undefined,\n        url: request.url,\n        body: Buffer.from(await request.arrayBuffer()),\n      });\n\n      return new Response('');\n    });\n  } else {\n    // eslint-disable-next-line deprecation/deprecation\n    protocol.registerStringProtocol(scheme, (request, complete) => {\n      callback({\n        windowId: request.headers[RENDERER_ID_HEADER],\n        url: request.url,\n        body: request.uploadData?.[0]?.bytes,\n      });\n\n      complete('');\n    });\n  }\n}\n"],"names":[],"mappings":"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"}