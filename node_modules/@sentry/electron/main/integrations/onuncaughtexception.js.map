{"version":3,"file":"onuncaughtexception.js","sources":["../../src/src/main/integrations/onuncaughtexception.ts"],"sourcesContent":["import { convertIntegrationFnToClass, defineIntegration, getCurrentScope } from '@sentry/core';\nimport { NodeClient } from '@sentry/node';\nimport { Event } from '@sentry/types';\nimport { dialog } from 'electron';\n\nconst INTEGRATION_NAME = 'OnUncaughtException';\n\n/** Capture unhandled errors. */\nexport const onUncaughtExceptionIntegration = defineIntegration(() => {\n  return {\n    name: INTEGRATION_NAME,\n    setupOnce() {\n      // noop\n    },\n    setup(client: NodeClient) {\n      const options = client.getOptions();\n\n      global.process.on('uncaughtException', (error: Error) => {\n        const scope = getCurrentScope();\n\n        scope.addEventProcessor(async (event: Event) => ({\n          ...event,\n          level: 'fatal',\n        }));\n\n        client.captureException(\n          error,\n          {\n            originalException: error,\n            data: {\n              mechanism: {\n                handled: false,\n                type: 'generic',\n              },\n            },\n          },\n          scope,\n        );\n\n        client.flush(options.shutdownTimeout || 2000).then(\n          () => {\n            if (options?.onFatalError) {\n              options.onFatalError(error);\n            } else if (global.process.listenerCount('uncaughtException') <= 2) {\n              // In addition to this handler there is always one in Electron\n              // The dialog is only shown if there are no other handlers\n              // eslint-disable-next-line no-console\n              console.error('Uncaught Exception:');\n              // eslint-disable-next-line no-console\n              console.error(error);\n              const ref = error.stack;\n              const stack = ref !== undefined ? ref : `${error.name}: ${error.message}`;\n              const message = `Uncaught Exception:\\n${stack}`;\n              dialog.showErrorBox('A JavaScript error occurred in the main process', message);\n            }\n          },\n          () => {\n            // ignore\n          },\n        );\n      });\n    },\n  };\n});\n\n/**\n * Capture unhandled errors.\n *\n * @deprecated Use `onUncaughtExceptionIntegration()` instead\n */\n// eslint-disable-next-line deprecation/deprecation\nexport const OnUncaughtException = convertIntegrationFnToClass(INTEGRATION_NAME, onUncaughtExceptionIntegration);\n"],"names":["defineIntegration","getCurrentScope","__awaiter","dialog","convertIntegrationFnToClass"],"mappings":";;;;AAKA,MAAM,gBAAgB,GAAG,qBAAqB,CAAC;AAE/C;AACa,MAAA,8BAA8B,GAAGA,sBAAiB,CAAC,MAAK;IACnE,OAAO;AACL,QAAA,IAAI,EAAE,gBAAgB;QACtB,SAAS,GAAA;;SAER;AACD,QAAA,KAAK,CAAC,MAAkB,EAAA;AACtB,YAAA,MAAM,OAAO,GAAG,MAAM,CAAC,UAAU,EAAE,CAAC;YAEpC,MAAM,CAAC,OAAO,CAAC,EAAE,CAAC,mBAAmB,EAAE,CAAC,KAAY,KAAI;AACtD,gBAAA,MAAM,KAAK,GAAGC,oBAAe,EAAE,CAAC;AAEhC,gBAAA,KAAK,CAAC,iBAAiB,CAAC,CAAO,KAAY,KAAIC,eAAA,CAAA,IAAA,EAAA,KAAA,CAAA,EAAA,KAAA,CAAA,EAAA,aAAA;AAAC,oBAAA,wCAC3C,KAAK,CAAA,EAAA,EACR,KAAK,EAAE,OAAO,KACd;AAAA,iBAAA,CAAA,CAAC,CAAC;AAEJ,gBAAA,MAAM,CAAC,gBAAgB,CACrB,KAAK,EACL;AACE,oBAAA,iBAAiB,EAAE,KAAK;AACxB,oBAAA,IAAI,EAAE;AACJ,wBAAA,SAAS,EAAE;AACT,4BAAA,OAAO,EAAE,KAAK;AACd,4BAAA,IAAI,EAAE,SAAS;AAChB,yBAAA;AACF,qBAAA;iBACF,EACD,KAAK,CACN,CAAC;AAEF,gBAAA,MAAM,CAAC,KAAK,CAAC,OAAO,CAAC,eAAe,IAAI,IAAI,CAAC,CAAC,IAAI,CAChD,MAAK;AACH,oBAAA,IAAI,OAAO,KAAP,IAAA,IAAA,OAAO,uBAAP,OAAO,CAAE,YAAY,EAAE;AACzB,wBAAA,OAAO,CAAC,YAAY,CAAC,KAAK,CAAC,CAAC;AAC7B,qBAAA;yBAAM,IAAI,MAAM,CAAC,OAAO,CAAC,aAAa,CAAC,mBAAmB,CAAC,IAAI,CAAC,EAAE;;;;AAIjE,wBAAA,OAAO,CAAC,KAAK,CAAC,qBAAqB,CAAC,CAAC;;AAErC,wBAAA,OAAO,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;AACrB,wBAAA,MAAM,GAAG,GAAG,KAAK,CAAC,KAAK,CAAC;wBACxB,MAAM,KAAK,GAAG,GAAG,KAAK,SAAS,GAAG,GAAG,GAAG,CAAA,EAAG,KAAK,CAAC,IAAI,KAAK,KAAK,CAAC,OAAO,CAAA,CAAE,CAAC;AAC1E,wBAAA,MAAM,OAAO,GAAG,CAAwB,qBAAA,EAAA,KAAK,EAAE,CAAC;AAChD,wBAAAC,eAAM,CAAC,YAAY,CAAC,iDAAiD,EAAE,OAAO,CAAC,CAAC;AACjF,qBAAA;iBACF,EACD,MAAK;;AAEL,iBAAC,CACF,CAAC;AACJ,aAAC,CAAC,CAAC;SACJ;KACF,CAAC;AACJ,CAAC,EAAE;AAEH;;;;AAIG;AACH;AACa,MAAA,mBAAmB,GAAGC,gCAA2B,CAAC,gBAAgB,EAAE,8BAA8B;;;;;"}